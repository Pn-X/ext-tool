class ExtSubscribe{constructor(e){this.messageId=ext.nextId();this.timestamp=(new Date).getTime();this.handler=e;this.target=null;this.action=null}resolve(){return this.target+"/"+this.action+"/"+this.messageId+"/"+this.timestamp+"/1"}}class ExtUnsubscribe{constructor(){this.timestamp=(new Date).getTime();this.target=null;this.action=null}resolve(){return this.target+"/"+this.action+"/"+this.messageId+"/"+this.timestamp+"/2"}}(function(){let e={_messageId:-1,_messageMap:new Map,_subscriberMap:new Map,_errorCodeMap:{0:"UnkownError",1:"ArgumentError",2:"AuthorityError",3:"UnrecognizedError",4:"Error"},nextId:function(){return++this._messageId},invoke:function(e,s,n){if(!this._validate(e)||!this._validate(s)){console.error("Invalid target or action");return}if(n instanceof ExtSubscribe){n.target=e;n.action=s;this._subscriberMap.set(this._generate(e,s,""),n);window.webkit.messageHandlers.ext.postMessage(n.resolve())}else if(n instanceof ExtUnsubscribe){n.target=e;n.action=s;var i=this._subscriberMap.get[this._generate(e,s,"")];if(i){this._subscriberMap.delete(this._generate(e,s,""));window.webkit.messageHandlers.ext.postMessage(n.resolve())}}else{let i=new t(e,s,n);if(i.needWaitCallback){this._messageMap.set(this._generate(e,s,i.messageId),i)}window.webkit.messageHandlers.ext.postMessage(i.resolve())}},_parse:function(e){var t={};let s=e.split("/");if(s.length>0){t["target"]=s[0]}if(s.length>1){t["action"]=s[1]}if(s.length>2){t["messageId"]=s[2]}if(s.length>3){t["timestamp"]=s[3]}if(s.length>4){t["kind"]=s[4]}if(s.length>5){t["valueType"]=s[5]}if(s.length>6){let e=this._convert(s[5],s[6]);if(e!=null&&e!=undefined){t["value"]=e}}return t},_convert:function(e,t){let s=decodeURI(t);if(e=="S"){return s}else if(e=="N"){return Number(t)}else if(e=="E"){let e=new Error;let t=JSON.parse(s);if(t!=null&&t!=undefined){e.message=t["m"];e.code=t["c"];e.name=this._errorCodeMap[e.code]}return e}else if(e=="A"){let e=JSON.parse(s);if(!(e instanceof Array)){return nil}return e}else if(e=="O"){let e=JSON.parse(s);return e}return t},_generate:function(e,t,s){return e+"/"+t+"/"+s},_validate:function(e){if(typeof e=="string"&&e.length>0){return true}return false},_d:function(e){let t=this._parse(e);if(t==null||t==undefined){return}let s=t["target"];let n=t["action"];let i=t["value"];let r=t["kind"];let a=t["messageId"];if(r=="0"){let e=this._generate(s,n,a);let t=this._messageMap.get(e);if(t==undefined||t==null){return}let i=new Error;i.name="Unresponde";if(typeof t.params["onFail"]=="function"){t.params["onFail"](i)}if(typeof t.params.onComplete=="function"){t.params["onComplete"](i)}this._messageMap.delete(e)}else if(r=="1"){let e=this._generate(s,n,"");let t=this._subscriberMap.get(e);if(t==undefined||t==null){return}if(t.messageId!=a){return}this._subscriberMap.delete(e)}},_s:function(e){let t=this._parse(e);if(t==null||t==undefined){return new Error}let s=t["target"];let n=t["action"];let i=t["value"];let r=t["messageId"];let a=this._generate(s,n,r);let l=this._messageMap.get(a);if(l==undefined||l==null){return new Error}if(typeof l.params["onSuccess"]=="function"){l.params["onSuccess"](i)}if(typeof l.params["onComplete"]=="function"){l.params["onComplete"](i)}this._messageMap.delete(a);return true},_f:function(e){let t=this._parse(e);if(t==null||t==undefined){return new Error}let s=t["target"];let n=t["action"];let i=t["value"];let r=t["messageId"];let a=this._generate(s,n,r);let l=this._messageMap.get(a);if(l==undefined||l==null){return new Error}if(typeof l.params["onFail"]=="function"){l.params["onFail"](i)}if(typeof l.params.onComplete=="function"){l.params["onComplete"](i)}this._messageMap.delete(a);return true},_o:function(e){let t=this._parse(e);if(t==null||t==undefined){return new Error}let s=t["target"];let n=t["action"];let i=t["value"];let r=t["messageId"];let a=this._subscriberMap.get(this._generate(s,n,""));if(a==undefined||a==null){return new Error}if(typeof a.handler=="function"){a.handler(i)}return true}};class t{constructor(t,s,n){this.messageId=e.nextId();this.target=t;this.action=s;this.params=n;this.timestamp=(new Date).getTime();this.resolvedValue=null;this.needWaitCallback=false;if(typeof n=="boolean"){this.valueType="N";if(n){this.resolvedValue=1}else{this.resolvedValue=0}}else if(typeof n=="number"){this.valueType="N";this.resolvedValue=n}else if(typeof n=="null"||typeof n=="undefined"){this.valueType="S";this.resolvedValue=""}else if(typeof n=="string"){this.valueType="S";this.resolvedValue=encodeURIComponent(n)}else if(n instanceof Array){this.valueType="E";this.resolvedValue=encodeURIComponent(n)}else if(n instanceof Array){this.valueType="A";this.resolvedValue=encodeURIComponent(JSON.stringify(n))}else{this.valueType="O";let e={};for(let t in this.params){let s=this.params[t];if(typeof s=="null"||typeof s=="undefined"||typeof s=="boolean"||typeof s=="string"||typeof s=="number"){e[t]=this.params[t];continue}if(t=="onSuccess"||t=="onFail"||t=="onComplete"){if(typeof s!="function"){continue}this.needWaitCallback=true}}this.resolvedValue=encodeURIComponent(JSON.stringify(e))}}resolve(){return this.target+"/"+this.action+"/"+this.messageId+"/"+this.timestamp+"/0/"+this.valueType+"/"+this.resolvedValue}}if(window.ext==null||window.ext==undefined){window.ext=e}})();